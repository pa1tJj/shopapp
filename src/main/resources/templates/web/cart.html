<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Gi·ªè H√†ng</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link th:href="@{/assets/css/web/cart.css}" rel="stylesheet" />
</head>
<body>
	<div th:insert="~{web/fragments/header :: headerShop}"></div>
	<div class="container py-4">
		<div>
			<h4 class="mb-4">üõí Gi·ªè H√†ng</h4>
		</div>
		<div class="row cart-header fw-semibold text-muted text-center">
			<div class="col-1">
				<input type="checkbox" id="checkAll" />
			</div>
			<div class="col-5 text-start">S·∫£n ph·∫©m</div>
			<div class="col-2">ƒê∆°n gi√°</div>
			<div class="col-2">S·ªë l∆∞·ª£ng</div>
			<div class="col-1">Th√†nh ti·ªÅn</div>
			<div class="col-1">Thao t√°c</div>
		</div>

		<div class="row cart-item align-items-center text-center"
			th:each="item : ${cartDetails}">
			<div class="col-1">
				<input type="checkbox" name="selectedIds" class="product-checkbox"
					th:value="${item.getProductEntity().getId()}"
					data-product-id="${item.getProductEntity().getId()}" />
			</div>
			<div class="col-5 d-flex text-start align-items-center">
				<img
					th:src="@{'/images/' + ${item.getProductEntity().getImageUrl()}}"
					class="me-3 product-img" />
				<div>
					<div class="product-name"
						th:text="${item.getProductEntity().getName()}"></div>
					<div class="text-muted small"
						th:text="${item.getProductEntity().getBrand()}"></div>
				</div>
			</div>
			<div class="col-2 text-danger"
				th:text="${item.getProductEntity().getPrice()} + 'ƒë'"></div>
			<div class="col-2">
				<div class="input-group quantity-control mx-auto">
					<!-- N√∫t gi·∫£m -->
					<button class="btn btn-outline-secondary btn-sm btn-down"
						type="button"
						th:data-product-id="${item.getProductEntity().getId()}">-</button>

					<!-- Input s·ªë l∆∞·ª£ng -->
					<input type="number"
						class="form-control form-control-sm text-center quantity-input"
						th:value="${item.getQuantity()}" min="1" readonly />

					<!-- N√∫t tƒÉng -->
					<button class="btn btn-outline-secondary btn-sm btn-up"
						type="button"
						th:data-product-id="${item.getProductEntity().getId()}">+</button>
				</div>
			</div>
			<div class="col-1" th:text="${item.getPriceTotal()}"></div>
			<input type="hidden" class="productId"
				th:value="${item.getProductEntity().getId()}" />
			<div class="col-1">
				<button class="btn btn-sm btn-outline-danger btn-delete-cart"
					type="button">
					<i class="fas fa-trash"></i>
				</button>
			</div>
		</div>
		<input type="hidden" name="userId" id="userId" th:value="${userId}" />

		<div class="row mt-4 justify-content-between align-items-center">
			<div class="col-md-6">
				<a href="/shop" class="btn btn-outline-secondary">‚Üê Ti·∫øp t·ª•c mua
					s·∫Øm</a>
			</div>
			<div class="col-md-6 text-end">
				<h5>
					T·ªïng thanh to√°n: <span class="text-danger fw-bold"></span>
				</h5>
				<button class="btn btn-danger mt-2" name="btnOrder" id="btnOrder">Mua h√†ng</button>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

	<script>
		$(document).ready(function() {
			$('.btn-up').click(function() {
				let $input = $(this).siblings('.quantity-input');
				let current = parseInt($input.val()) || 0;
				let newQuantity = current + 1;
				let userId = $('#userId').val();
				$input.val(newQuantity);

				let productId = $(this).data('product-id');

				updateQuantityOnServer(productId, newQuantity, userId);
			});

			$('.btn-down').click(function() {
				let $input = $(this).siblings('.quantity-input');
				let current = parseInt($input.val()) || 0;
				let newQuantity = current > 1 ? current - 1 : 1;
				$input.val(newQuantity);
				let userId = $('#userId').val();

				let productId = $(this).data('product-id');

				updateQuantityOnServer(productId, newQuantity, userId);
			});

			function updateQuantityOnServer(productId, quantity, userId) {
				$.ajax({
					url : '/add-to-cart', 
					type : 'POST',
					contentType : 'application/json',
					data : JSON.stringify({
						productId : productId,
						quantity : quantity,
						userId: userId
					}),
					success : function(response) {
						let userId = $('#userId').val();
						window.location.href = "/cart-" + userId;
					},
					error : function(err) {
						alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi·ªè h√†ng");
					}
				});
			}
		});
		
		$(document).on('click', '.btn-delete-cart', function(e) {
			e.preventDefault();
			const $row = $(this).closest('.cart-item');
			const productId = $row.find('.productId').val();
			const userId = $('#userId').val();
			deleteProductInCart(productId, userId);
		});
		
		function deleteProductInCart(productId, userId) {
			$.ajax({
				url: '/cart-delete',
			    type: 'POST',
			    contentType: 'application/json',
			    data:JSON.stringify({
					productId : productId,
					userId: userId
				}),
				success: function(res) {
					let userId = $('#userId').val();
					window.location.href = "/cart-" + userId;
				}
			})
		}
		
		// 1. Khi click v√†o "Ch·ªçn t·∫•t c·∫£"
		$('#checkAll').on('change', function() {
		    $('.product-checkbox').prop('checked', this.checked);
		    updateTotalPrice();
		});

		// 2. Khi click t·ª´ng checkbox s·∫£n ph·∫©m
		$(document).on('change', '.product-checkbox', function() {
		    let allChecked = $('.product-checkbox').length === $('.product-checkbox:checked').length;
		    $('#checkAll').prop('checked', allChecked);
		    updateTotalPrice();
		});	
		
		function updateTotalPrice() {
		    var selectedProductIds = [];
		    $('.product-checkbox:checked').each(function () {
		        selectedProductIds.push($(this).val());
		    });

		    var userId = $('#userId').val();
		    $.ajax({
		        url: '/cart-select',
		        type: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify({
		            productId: selectedProductIds, 
		            userId: userId
		        }),
		        success: function (response) {
		        	$('.text-danger.fw-bold').text(response.totalAmount);
		        },
		        error: function () {
		            alert("L·ªói khi ch·ªçn s·∫£n ph·∫©m");
		        }
		    });
		}
		
		$('#btnOrder').click(function(e){
			e.preventDefault();
		    var selectedProductIds = [];
		    var userId = $('#userId').val();
		    $('.product-checkbox:checked').each(function () {
		        selectedProductIds.push($(this).val());
		    });
			$.ajax({
				url: '/order-payment',
				type: 'GET',
		        data: {
		            productId: selectedProductIds,
		            userId: userId
		        },
		        success: function (response) {
		        	window.location.href="/order-payment?userId=" + userId + "&productId=" + selectedProductIds;
		        },
			})
		})
	</script>
</body>
</html>
