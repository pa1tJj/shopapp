<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Thanh To√°n ƒê∆°n H√†ng</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link th:href="@{/assets/css/web/order_payment.css}" rel="stylesheet" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div th:insert="~{web/fragments/header :: headerShop}"></div>
	<div class="container">
		<div class="mb-4">
			<div class="section-title">üó∫ V·ªã tr√≠ giao h√†ng</div>
			<div id="map" style="height: 350px; border: 1px solid #ccc; border-radius: 6px;"></div>
		</div>
		<div class="checkout-container">
			<form method="POST" id="formOrder" th:object="${orders}" >
				<!-- 1. Th√¥ng tin ng∆∞·ªùi nh·∫≠n -->
				<div class="mb-4">
					<div class="section-title">üìç Th√¥ng tin nh·∫≠n h√†ng</div>
					<div class="row g-3">
						<div class="col-md-6">
							<label for="fullName" class="form-label">H·ªç t√™n ng∆∞·ªùi nh·∫≠n</label> <input
								type="text" class="form-control" id="recipentName" name="recipentName"
								required th:value="${orders.recipentName}"/>
						</div>
						<div class="col-md-6">
							<label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label> <input
								type="tel" class="form-control" id="recipentPhone" name="recipentPhone" required th:value="${orders.recipentPhone}"/>
						</div>
						<div class="col-12">
							<label for="address" class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
							<textarea class="form-control" id="shippingAddress" name="shippingAddress" th:field="*{shippingAddress}"
								rows="2" required></textarea>
						</div>
						<div class="col-12">
							<label for="note" class="form-label">üìù Ghi nh·ªõ / Ghi ch√∫</label>
							<textarea class="form-control" id="notes" name="notes" rows="2"
								placeholder="V√≠ d·ª•: G·ªçi tr∆∞·ªõc khi giao, giao bu·ªïi s√°ng..." th:field="*{notes}"></textarea>
						</div>
					</div>
				</div>

				<!-- 2. Danh s√°ch s·∫£n ph·∫©m -->
				<div class="mb-4">
					<div class="section-title">üì¶ S·∫£n ph·∫©m</div>
					<div class="table-responsive" >
						<table class="table align-middle">
							<thead>
								<tr>
									<th>S·∫£n ph·∫©m</th>
									<th>ƒê∆°n gi√°</th>
									<th>S·ªë l∆∞·ª£ng</th>
									<th>Th√†nh ti·ªÅn</th>
								</tr>
							</thead>
							<tbody th:each="item : ${product}">
								<tr>
									<td>
										<div class="d-flex align-items-center">
											<img th:src="@{'/images/' + ${item.getProductEntity().getImageUrl()}}" class="product-img me-2" />
											<div>
												<div></div>
												<div class="text-muted small"></div>
											</div>
										</div>
									</td>
									<td class="text-danger" th:text="${item.getProductEntity().getPrice() + 'ƒë'}"></td>
									<td th:text="${item.getQuantity()}"></td>
									<td th:text="${item.getPriceTotal()}"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<!-- 3. Ph∆∞∆°ng th·ª©c thanh to√°n -->
				<div class="container mt-4">
					<h4>Ph∆∞∆°ng th·ª©c thanh to√°n</h4>
					<!-- Ch·ªçn lo·∫°i thanh to√°n -->
					<div class="form-check">
						<input class="form-check-input" type="radio" name="paymentMethod"
							id="paymentCod" value="cod" checked> <label
							class="form-check-label" for="paymentCod"> Thanh to√°n khi
							nh·∫≠n h√†ng (COD) </label>
					</div>

					<div class="form-check">
						<input class="form-check-input" type="radio" name="paymentMethod"
							id="paymentOnline" value="online"> <label
							class="form-check-label" for="paymentOnline"> Thanh to√°n
							online th√¥ng qua VNPay</label>
					</div>

					<!-- N·∫øu ch·ªçn Online th√¨ hi·ªán th√™m c√°c ph∆∞∆°ng th·ª©c con 
					<div id="onlineOptions" class="mt-3" style="display: none;">
						<h5>Ph∆∞∆°ng th·ª©c online</h5>
						<div class="form-check ms-3">
							<input class="form-check-input" type="radio" name="onlineOption"
								id="qrCode" value="qr"> <label class="form-check-label"
								for="qrCode"> Thanh to√°n b·∫±ng m√£ QR </label>
						</div>
						<div class="form-check ms-3">
							<input class="form-check-input" type="radio" name="onlineOption"
								id="vnpay" value="vnpay"> <label
								class="form-check-label" for="vnpay"> VNPAY </label>
						</div>
					</div>-->
				</div>

				<!-- 4. T·ªïng ti·ªÅn v√† ƒê·∫∑t h√†ng -->
				<div class="checkout-summary p-3 border rounded mt-4">
					<div class="d-flex justify-content-between mb-2">
						<span class="fs-6">T·ªïng ti·ªÅn h√†ng:</span> <span
							class="fw-bold text-danger" th:text="${priceAll}"></span>
					</div>
					<div class="d-flex justify-content-between mb-2">
						<span class="fs-6">Ph√≠ v·∫≠n chuy·ªÉn:</span> <span class="fw-bold"
							>20.000‚Ç´</span>
					</div>
					<div class="d-flex justify-content-between border-top pt-2 mb-3">
						<span class="fs-5" >T·ªïng thanh to√°n:</span > <span
							th:text="${pricePayment}" class="fw-bold text-danger fs-5"
							></span>
					</div>
					<div class="text-muted small mb-3">
						Nh·∫•n "ƒê·∫∑t h√†ng" ƒë·ªìng nghƒ©a v·ªõi vi·ªác b·∫°n ƒë·ªìng √Ω tu√¢n theo <a
							href="/terms" target="_blank">ƒêi·ªÅu kho·∫£n</a> c·ªßa ch√∫ng t√¥i.
					</div>
					<div class="text-end">
						<button class="btn btn-order px-4" type="submit" id="btnOrder">üõç ƒê·∫∑t
							h√†ng</button>
					</div>
				</div>
				<input type="hidden" name="userId" th:value="${userId}"/>
			</form>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	
	<script>
		const map = L.map('map').setView([ 21.0285, 105.8542 ], 13); // v√≠ d·ª•: H√† N·ªôi

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution : '&copy; OpenStreetMap contributors'
		}).addTo(map);

		L.marker([ 21.0285, 105.8542 ]).addTo(map).bindPopup(
				'V·ªã tr√≠ giao h√†ng m·∫∑c ƒë·ªãnh').openPopup();
		
		$(document).ready(function () {
	        $('input[name="paymentMethod"]').change(function () {
	            if ($('#paymentOnline').is(':checked')) {
	                $('#onlineOptions').slideDown();
	            } else {
	                $('#onlineOptions').slideUp();
	                $('input[name="onlineOption"]').prop('checked', false);
	            }
	        });
	    });
		
		//ƒë·∫∑t h√†ng
		function getOrder(formData) {
			$.ajax({
				url:'/orders',
				type:'POST',
				data:  formData,     <!--JSON.stringify(data), stringify ch·ªâ l·∫•y input d·∫°ng text-->
	    	    processData: false,
	    		contentType: false,
	    		success: function(response) {  
	    			if(response.message === "cod") {
	    				window.location.href = response.url;
	    			}
	    			
	    		}
			});
		}
		
		$('#btnOrder').click(function(e){
			e.preventDefault();
			var data = $('#formOrder')[0];
	    	var formData = new FormData(data);
	    	var paymentMethod = $('input[name="paymentMethod"]:checked').val();
			getOrder(formData);

			if (paymentMethod === 'online') {
				// N·∫øu l√† online th√¨ g·ªçi sang API create-payment
				$.ajax({
					url: '/create_payment',
					type: 'GET',
					data: Object.fromEntries(formData), // chuy·ªÉn FormData sang object
					success: function (response) {
						// Backend tr·∫£ v·ªÅ link VNPay th√¨ redirect sang ƒë√≥
						window.location.href = response.url;
					}
				});
			} else {
				// N·∫øu COD th√¨ t·∫°o order b√¨nh th∆∞·ªùng
				getOrder(formData);
			}
		})
		
		function getPlaced() {
			
		}
		
	</script>
</body>
</html>
